@model SalaryManager.Models.Employee
@{
    Layout = "_Layout";
    ViewData["Title"] = "Create Employee";
    
    // Helper function to check if a property has validation errors
    string GetInvalidClass(string propertyName)
    {
        if (ViewData.ModelState.ContainsKey(propertyName))
        {
            var modelState = ViewData.ModelState[propertyName];
            if (modelState?.ValidationState.ToString() == "Invalid")
            {
                return "is-invalid";
            }
        }
        return "";
    }
}

<style>
    .form-control.is-invalid,
    .form-select.is-invalid {
        border-color: #dc3545;
        background-image: none;
    }
    
    .invalid-feedback {
        display: block;
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 0.25rem;
    }
    
    .form-control:focus.is-invalid,
    .form-select:focus.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
</style>

<div class="container mt-5">
    <div class="row">
        <div class="col-md-6">
            <h1>Add New Employee</h1>
            <hr />
            
            @if (!ViewData.ModelState.IsValid && ViewData.ModelState.Count > 0)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong><i class="bi bi-exclamation-circle"></i> Please correct the following errors:</strong>
                    <ul class="mb-0 mt-2">
                        @foreach (var modelState in ViewData.ModelState.Values)
                        {
                            @foreach (var error in modelState.Errors)
                            {
                                <li>@error.ErrorMessage</li>
                            }
                        }
                    </ul>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            <form asp-action="Create" asp-controller="Employees" method="post" novalidate id="createForm">
                @Html.AntiForgeryToken()
                <div class="mb-3">
                    <label asp-for="FirstName" class="form-label">First Name <span class="text-danger">*</span></label>
                    <input asp-for="FirstName" class="form-control @GetInvalidClass(nameof(Model.FirstName))" required placeholder="Enter first name" />
                    <span asp-validation-for="FirstName" class="invalid-feedback d-block"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="LastName" class="form-label">Last Name <span class="text-danger">*</span></label>
                    <input asp-for="LastName" class="form-control @GetInvalidClass(nameof(Model.LastName))" required placeholder="Enter last name" />
                    <span asp-validation-for="LastName" class="invalid-feedback d-block"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Email" class="form-label">Email <span class="text-danger">*</span></label>
                    <input asp-for="Email" class="form-control @GetInvalidClass(nameof(Model.Email))" type="email" required placeholder="example@email.com" />
                    <span asp-validation-for="Email" class="invalid-feedback d-block"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Department" class="form-label">Department <span class="text-danger">*</span></label>
                    <select asp-for="Department" class="form-select @GetInvalidClass(nameof(Model.Department))" required>
                        <option value="">-- Select Department --</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Sales">Sales</option>
                        <option value="HR">HR</option>
                        <option value="Finance">Finance</option>
                    </select>
                    <span asp-validation-for="Department" class="invalid-feedback d-block"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="BaseSalary" class="form-label">Base Salary <span class="text-danger">*</span></label>
                    <input asp-for="BaseSalary" class="form-control @GetInvalidClass(nameof(Model.BaseSalary))" type="number" step="0.01" min="0" required placeholder="0.00" />
                    <small class="form-text text-muted">Must be greater than or equal to 0</small>
                    <span asp-validation-for="BaseSalary" class="invalid-feedback d-block"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="BonusPercentage" class="form-label">Bonus Percentage (%) <span class="text-danger">*</span></label>
                    <input asp-for="BonusPercentage" class="form-control @GetInvalidClass(nameof(Model.BonusPercentage))" type="number" step="0.1" min="0" max="100" required placeholder="0.0" />
                    <small class="form-text text-muted">Must be between 0 and 100</small>
                    <span asp-validation-for="BonusPercentage" class="invalid-feedback d-block"></span>
                </div>

                <div class="d-grid gap-2 d-sm-flex">
                    <button type="submit" class="btn btn-primary">Create Employee</button>
                    <a href="/Employees/Index" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // Add Bootstrap validation styling for client-side validation
        (function() {
            'use strict';
            window.addEventListener('load', function() {
                console.log('Setting up form validation');
                var forms = document.querySelectorAll('#createForm');
                Array.prototype.slice.call(forms).forEach(function(form) {
                    console.log('Attaching submit event listener to form');
                    form.addEventListener('submit', function(event) {
                        console.log('Form submit event triggered');
                        if (form.checkValidity() === false) {
                            console.log('Form is invalid, preventing submission');
                            event.preventDefault();
                            event.stopPropagation();
                            
                            // Add invalid class to all invalid fields
                            var inputs = form.querySelectorAll('input, select, textarea');
                            inputs.forEach(function(input) {
                                if (!input.checkValidity()) {
                                    input.classList.add('is-invalid');
                                } else {
                                    input.classList.remove('is-invalid');
                                }
                            });
                        } else {
                            console.log('Form is valid, allowing submission');
                            // Remove invalid classes if form is valid
                            var inputs = form.querySelectorAll('input, select, textarea');
                            inputs.forEach(function(input) {
                                input.classList.remove('is-invalid');
                            });
                        }
                    }, false);
                    
                    // Remove invalid class when user starts typing
                    var inputs = form.querySelectorAll('input, select, textarea');
                    inputs.forEach(function(input) {
                        input.addEventListener('input', function() {
                            if (input.checkValidity()) {
                                input.classList.remove('is-invalid');
                            }
                        });
                    });
                });
            }, false);
        })();
    </script>
}

